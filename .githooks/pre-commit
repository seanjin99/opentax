#!/usr/bin/env bash
set -euo pipefail

# Block committing local datastore / sqlite artifacts.
BLOCK_REGEX='(^|/)(opentax\.db|opentax\.db-shm|opentax\.db-wal|[^/]+\.sqlite3?|[^/]+\.db)$'

staged_files=$(git diff --cached --name-only)
if [[ -z "${staged_files}" ]]; then
  exit 0
fi

violations=$(printf '%s
' "$staged_files" | grep -E "$BLOCK_REGEX" || true)

if [[ -n "$violations" ]]; then
  echo "‚ùå Commit blocked: database files must not be committed."
  echo "Remove from index with:"
  echo "  git rm --cached <file>"
  echo
  echo "Blocked files:"
  echo "$violations"
  exit 1
fi

exit 0
